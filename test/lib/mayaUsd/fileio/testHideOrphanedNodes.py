#!/usr/bin/env python

#
# Copyright 2022 Autodesk
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

import fixturesUtils

import mayaUsd.lib
import mayaUsd.ufe

import mayaUtils

from pxr import UsdGeom

from maya import cmds
from maya import standalone
from maya.api import OpenMaya as om
 
import ufe

import os.path
import unittest

from testUtils import getTestScene

def visibilityPlug(pathStr):
    dagPath = om.MSelectionList().add(pathStr).getDagPath(0)
    return om.MFnDagNode(dagPath).findPlug('visibility', True)

class HideOrphanedNodesTestCase(unittest.TestCase):
    '''Maya pulled nodes must be hidden when USD scene structure requires it.
    '''

    # We will use the following scene in our tests:
    #
    # A is unloadable, has variant set abVariant (a, b)
    # B has variant set cdVariant (c, d)
    #
    # A variant selection (a), B variant selection (c):
    #
    # stage1
    #       |stageShape1
    #                   /A (a)
    #                     /B (c)
    #                       /C (xformOp:translate = (1, 2, 3))
    #                   /D
    #                     /E   
    #
    # A variant selection (a), B variant selection (d):
    #
    # stage1
    #       |stageShape1
    #                   /A (a)
    #                     /B (d)
    #                       /C (xformOp:translate = (4, 5, 6))
    #                   /D
    #                     /E   
    #
    # A variant selection (b):
    #
    # stage1
    #       |stageShape1
    #                   /A (b)
    #                     /F
    #                   /D
    #                     /E   
    pluginsLoaded = False

    @classmethod
    def setUpClass(cls):
        fixturesUtils.readOnlySetUpClass(__file__, loadPlugin=False)

        if not cls.pluginsLoaded:
            cls.pluginsLoaded = mayaUtils.isMayaUsdPluginLoaded()

    @classmethod
    def tearDownClass(cls):
        standalone.uninitialize()

    def setUp(self):
        cmds.file(new=True, force=True)

        testFile = getTestScene("hideOrphanedNodes", "hideOrphanedNodes.usda")
        self.ps, stage = mayaUtils.createProxyFromFile(testFile)

        self.cPathStr = self.ps + ',/A/B/C'
        self.ePathStr = self.ps + ',/D/E'

    def getVisibilityPlugs(self, mayaPaths):
        visibilityPlugs = {}

        for pathStr, mayaPath in mayaPaths.items():
            # Get the pull parent from the path.  Pulled node is visible.
            visibility = visibilityPlug(ufe.PathString.string(mayaPath.pop()))
            visibilityPlugs[pathStr] = visibility

        return visibilityPlugs

    def pullAndGetParentVisibility(self, pathStrings):

        mayaPaths = {}

        for pathStr in pathStrings:
            # See testEditAsMaya.py comments: PathMappingHandler toHost()
            # unimplemented, use selection to get pull host path.
            self.assertTrue(mayaUsd.lib.PrimUpdaterManager.editAsMaya(pathStr))
            mayaItem = ufe.GlobalSelection.get().front()
            mayaPath = mayaItem.path()
            self.assertEqual(mayaPath.nbSegments(), 1)
            mayaPaths[pathStr] = mayaPath

        visibilityPlugs = self.getVisibilityPlugs(mayaPaths)

        for pathStr, visibility in visibilityPlugs.items():
            self.assertTrue(visibility.asBool())
        
        return visibilityPlugs, mayaPaths

    def testHideOnDelete(self):
        # Pull on C and E.
        pullParentVisibilityPlug, _ = self.pullAndGetParentVisibility(
            [self.cPathStr, self.ePathStr])

        # Delete the proxy shape.  Both pulled nodes should be orphaned and
        # hidden.
        cmds.delete(self.ps)

        for pathStr in pullParentVisibilityPlug:
            self.assertFalse(pullParentVisibilityPlug[pathStr].asBool())

        # Undo: pulled nodes now back as visible.
        cmds.undo()

        for pathStr in pullParentVisibilityPlug:
            self.assertTrue(pullParentVisibilityPlug[pathStr].asBool())

    def testHideOnInactivate(self):
        # Pull on C and E.
        pullParentVisibilityPlug, _ = self.pullAndGetParentVisibility(
            [self.cPathStr, self.ePathStr])

        # Inactivate B, C's parent.
        bPath = ufe.PathString.path(self.cPathStr).pop()
        bPrim = mayaUsd.ufe.ufePathToPrim(ufe.PathString.string(bPath))
        bPrim.SetActive(False)

        # Pulled node for C is hidden
        self.assertFalse(pullParentVisibilityPlug[self.cPathStr].asBool())
        self.assertTrue(pullParentVisibilityPlug[self.ePathStr].asBool())

        bPrim.SetActive(True)

        self.assertTrue(pullParentVisibilityPlug[self.cPathStr].asBool())
        self.assertTrue(pullParentVisibilityPlug[self.ePathStr].asBool())

    def testHideOnPayloadUnload(self):
        # Pull on C and E.
        pullParentVisibilityPlug, _ = self.pullAndGetParentVisibility(
            [self.cPathStr, self.ePathStr])

        # Unload A, C's grandparent.
        aPath = ufe.PathString.path(self.cPathStr).pop().pop()
        aPrim = mayaUsd.ufe.ufePathToPrim(ufe.PathString.string(aPath))

        aPrim.Unload()

        # Pulled node for C is hidden
        self.assertFalse(pullParentVisibilityPlug[self.cPathStr].asBool())
        self.assertTrue(pullParentVisibilityPlug[self.ePathStr].asBool())

        aPrim.Load()

        self.assertTrue(pullParentVisibilityPlug[self.cPathStr].asBool())
        self.assertTrue(pullParentVisibilityPlug[self.ePathStr].asBool())

    def testHideOnNestedVariantSwitch(self):
        # Pull on C and E.
        pullParentVisibilityPlug, _ = self.pullAndGetParentVisibility(
            [self.cPathStr, self.ePathStr])

        # B's variant set cdVariant is set to variant selection c, so Maya
        # version of pulled node C has translation (1, 2, 3).
        variantCXlation = (1, 2, 3)
        cPrim = mayaUsd.ufe.ufePathToPrim(self.cPathStr)
        cMayaPathStr = mayaUsd.lib.PrimUpdaterManager.readPullInformation(cPrim)
        cDagPath = om.MSelectionList().add(cMayaPathStr).getDagPath(0)
        cFn= om.MFnTransform(cDagPath)
        self.assertEqual(cFn.translation(om.MSpace.kObject),
                         om.MVector(*variantCXlation))

        bPrim = cPrim.GetParent()
        cdVariant = bPrim.GetVariantSet('cdVariant')
        self.assertEqual(cdVariant.GetVariantSelection(), 'c')

        # Switch B's variant set cdVariant to variant selection d.  The prim in
        # that variant is also called C, but it is a different prim, with a
        # different translation, so the pulled node is hidden.
        cdVariant.SetVariantSelection('d')

        cPrim = mayaUsd.ufe.ufePathToPrim(self.cPathStr)
        cXformable = UsdGeom.Xformable(cPrim)
        self.assertEqual(cXformable.GetLocalTransformation().GetRow3(3), [4, 5, 6])

        self.assertFalse(pullParentVisibilityPlug[self.cPathStr].asBool())
        self.assertTrue(pullParentVisibilityPlug[self.ePathStr].asBool())

        # Revert back to variant selection c, pulled node is shown.
        cdVariant.SetVariantSelection('c')

        self.assertTrue(pullParentVisibilityPlug[self.cPathStr].asBool())
        self.assertTrue(pullParentVisibilityPlug[self.ePathStr].asBool())

    def _saveScene(self, filename):
        cmds.file(rename=filename)
        cmds.file(save=True, force=True, type="mayaAscii")
    
    def _reloadScene(self, filename):
        cmds.file(new=True, force=True)
        cmds.file(filename, open=True)

    def testHideOnNestedVariantSwitchOnReload(self):
        # Pull on C and E.
        pullParentVisibilityPlug, mayaPaths = self.pullAndGetParentVisibility(
            [self.cPathStr, self.ePathStr])

        # B's variant set cdVariant is set to variant selection c, so Maya
        # version of pulled node C has translation (1, 2, 3).
        variantCXlation = (1, 2, 3)
        cPrim = mayaUsd.ufe.ufePathToPrim(self.cPathStr)
        cMayaPathStr = mayaUsd.lib.PrimUpdaterManager.readPullInformation(cPrim)
        self.assertNotEqual(cMayaPathStr, '')
        cDagPath = om.MSelectionList().add(cMayaPathStr).getDagPath(0)
        cFn= om.MFnTransform(cDagPath)
        self.assertEqual(cFn.translation(om.MSpace.kObject),
                         om.MVector(*variantCXlation))

        bPrim = cPrim.GetParent()
        cdVariant = bPrim.GetVariantSet('cdVariant')
        self.assertEqual(cdVariant.GetVariantSelection(), 'c')

        # Switch B's variant set cdVariant to variant selection d.  The prim in
        # that variant is also called C, but it is a different prim, with a
        # different translation, so the pulled node is hidden.
        cdVariant.SetVariantSelection('d')

        cPrim = mayaUsd.ufe.ufePathToPrim(self.cPathStr)
        cXformable = UsdGeom.Xformable(cPrim)
        self.assertEqual(cXformable.GetLocalTransformation().GetRow3(3), [4, 5, 6])

        self.assertFalse(pullParentVisibilityPlug[self.cPathStr].asBool())
        self.assertTrue(pullParentVisibilityPlug[self.ePathStr].asBool())

        # Also verify that the session layer data has been removed.
        cMayaPathStr = mayaUsd.lib.PrimUpdaterManager.readPullInformation(cPrim)
        self.assertEqual(cMayaPathStr, '')

        cmds.optionVar(intValue=('mayaUsd_SerializedUsdEditsLocation', 2))
        filename = os.path.abspath("orphaned.ma")
        self._saveScene(filename)
        self._reloadScene(filename)

        # # Verify the hidden state of the edited nodes.
        pullParentVisibilityPlug = self.getVisibilityPlugs(mayaPaths)

        self.assertFalse(pullParentVisibilityPlug[self.cPathStr].asBool())
        self.assertTrue(pullParentVisibilityPlug[self.ePathStr].asBool())

        # # Revert back to variant selection c, pulled node is shown.
        cPrim = mayaUsd.ufe.ufePathToPrim(self.cPathStr)
        bPrim = cPrim.GetParent()
        cdVariant = bPrim.GetVariantSet('cdVariant')
        cdVariant.SetVariantSelection('c')

        self.assertTrue(pullParentVisibilityPlug[self.cPathStr].asBool())
        self.assertTrue(pullParentVisibilityPlug[self.ePathStr].asBool())

        # Also verify that the session layer data has been restored.
        cMayaPathStr = mayaUsd.lib.PrimUpdaterManager.readPullInformation(cPrim)
        self.assertNotEqual(cMayaPathStr, '')

    def testHideOnNestingVariantSwitch(self):
        # Pull on C and E.
        pullParentVisibilityPlug, _ = self.pullAndGetParentVisibility(
            [self.cPathStr, self.ePathStr])

        # A's variant set abVariant is set to variant selection a, so Maya
        # version of pulled node C is present and has translation (1, 2, 3).
        variantCXlation = (1, 2, 3)
        cPrim = mayaUsd.ufe.ufePathToPrim(self.cPathStr)
        cMayaPathStr = mayaUsd.lib.PrimUpdaterManager.readPullInformation(cPrim)
        cDagPath = om.MSelectionList().add(cMayaPathStr).getDagPath(0)
        cFn= om.MFnTransform(cDagPath)
        self.assertEqual(cFn.translation(om.MSpace.kObject),
                         om.MVector(*variantCXlation))

        aPrim = cPrim.GetParent().GetParent()
        abVariant = aPrim.GetVariantSet('abVariant')
        self.assertEqual(abVariant.GetVariantSelection(), 'a')
        self.assertEqual(aPrim.GetChildrenNames()[0], 'B')

        # Switch A's variant set abVariant to variant selection b.  Pulled node
        # C will be hidden.
        abVariant.SetVariantSelection('b')
        self.assertEqual(aPrim.GetChildrenNames()[0], 'F')

        self.assertFalse(pullParentVisibilityPlug[self.cPathStr].asBool())
        self.assertTrue(pullParentVisibilityPlug[self.ePathStr].asBool())

        # Revert back to variant selection a, pulled node is shown.
        abVariant.SetVariantSelection('a')

        self.assertTrue(pullParentVisibilityPlug[self.cPathStr].asBool())
        self.assertTrue(pullParentVisibilityPlug[self.ePathStr].asBool())

    def testHideOnVariantSwitchAndDeleteUndo(self):
        '''
        Edit-as-Maya an object, switch a variant in its ancestor, which
        should hide the Maya edited object, delete an ancestor and undo
        the deletion. The Maya object should still be deleted.
        '''
        # Pull on C.
        pullParentVisibilityPlug, _ = self.pullAndGetParentVisibility(
            [self.cPathStr])

        # A's variant set abVariant is set to variant selection a, so Maya
        # version of pulled node C is present and has translation (1, 2, 3).
        variantCXlation = (1, 2, 3)
        cPrim = mayaUsd.ufe.ufePathToPrim(self.cPathStr)
        cMayaPathStr = mayaUsd.lib.PrimUpdaterManager.readPullInformation(cPrim)
        cDagPath = om.MSelectionList().add(cMayaPathStr).getDagPath(0)
        cFn= om.MFnTransform(cDagPath)
        self.assertEqual(cFn.translation(om.MSpace.kObject),
                         om.MVector(*variantCXlation))

        aPrim = cPrim.GetParent().GetParent()
        abVariant = aPrim.GetVariantSet('abVariant')
        self.assertEqual(abVariant.GetVariantSelection(), 'a')
        self.assertEqual(aPrim.GetChildrenNames()[0], 'B')

        # Switch A's variant set abVariant to variant selection b.  Pulled node
        # C will be hidden.
        abVariant.SetVariantSelection('b')
        self.assertEqual(aPrim.GetChildrenNames()[0], 'F')

        self.assertFalse(pullParentVisibilityPlug[self.cPathStr].asBool())

        cmds.delete(self.ps)
        self.assertFalse(pullParentVisibilityPlug[self.cPathStr].asBool())

        cmds.undo()
        self.assertFalse(pullParentVisibilityPlug[self.cPathStr].asBool())

        # Revert back to variant selection a, pulled node is shown.
        abVariant.SetVariantSelection('a')

        self.assertTrue(pullParentVisibilityPlug[self.cPathStr].asBool())

    def testShowOnCorrectVariantAndDeleteUndo(self):
        '''
        Edit-as-Maya an object, stay ton the correct variant in its ancestor,
        delete an ancestor and undo the deletion. The Maya object should still
        be visible.
        '''
        # Pull on C.
        pullParentVisibilityPlug, _ = self.pullAndGetParentVisibility(
            [self.cPathStr])

        # A's variant set abVariant is set to variant selection a, so Maya
        # version of pulled node C is present and has translation (1, 2, 3).
        variantCXlation = (1, 2, 3)
        cPrim = mayaUsd.ufe.ufePathToPrim(self.cPathStr)
        cMayaPathStr = mayaUsd.lib.PrimUpdaterManager.readPullInformation(cPrim)
        cDagPath = om.MSelectionList().add(cMayaPathStr).getDagPath(0)
        cFn= om.MFnTransform(cDagPath)
        self.assertEqual(cFn.translation(om.MSpace.kObject),
                         om.MVector(*variantCXlation))

        aPrim = cPrim.GetParent().GetParent()
        abVariant = aPrim.GetVariantSet('abVariant')
        self.assertEqual(abVariant.GetVariantSelection(), 'a')
        self.assertEqual(aPrim.GetChildrenNames()[0], 'B')
        self.assertTrue(pullParentVisibilityPlug[self.cPathStr].asBool())

        cmds.delete(self.ps)
        self.assertFalse(pullParentVisibilityPlug[self.cPathStr].asBool())

        cmds.undo()
        self.assertTrue(pullParentVisibilityPlug[self.cPathStr].asBool())

if __name__ == '__main__':
    unittest.main(verbosity=2)
